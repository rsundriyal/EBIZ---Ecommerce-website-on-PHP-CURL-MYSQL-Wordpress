!function(e,t,s,i){function a(){this.opts=e.extend({},o),this.premium=e.extend({},_)}var n="ylc_console",r="plugin_"+n,o={app_id:"",user_info:{user_id:null,user_name:null,user_email:null,gravatar:null,user_type:null,avatar_type:null,avatar_image:null,current_page:null,user_ip:null}},_={};a.prototype={init:function(t,s){e.extend(this.opts,t),this.data={auth:null,ref:null,is_mobile:!1,active_user_id:0,mode:"offline",logged:!1,assets_url:ylc.plugin_url,user:{},online_ops:{}},this.strings={months:[ylc.strings.months.jan,ylc.strings.months.feb,ylc.strings.months.mar,ylc.strings.months.apr,ylc.strings.months.may,ylc.strings.months.jun,ylc.strings.months.jul,ylc.strings.months.aug,ylc.strings.months.sep,ylc.strings.months.oct,ylc.strings.months.nov,ylc.strings.months.dec],months_short:[ylc.strings.months_short.jan,ylc.strings.months_short.feb,ylc.strings.months_short.mar,ylc.strings.months_short.apr,ylc.strings.months_short.may,ylc.strings.months_short.jun,ylc.strings.months_short.jul,ylc.strings.months_short.aug,ylc.strings.months_short.sep,ylc.strings.months_short.oct,ylc.strings.months_short.nov,ylc.strings.months_short.dec],time:{suffix:ylc.strings.time.suffix,seconds:ylc.strings.time.seconds,minute:ylc.strings.time.minute,minutes:ylc.strings.time.minutes,hour:ylc.strings.time.hour,hours:ylc.strings.time.hours,day:ylc.strings.time.day,days:ylc.strings.time.days,month:ylc.strings.time.month,months:ylc.strings.time.months,year:ylc.strings.time.year,years:ylc.strings.time.years},msg:{chat_title:ylc.strings.msg.chat_title,prechat_msg:ylc.strings.msg.prechat_msg,welc_msg:ylc.strings.msg.welc_msg,start_chat:ylc.strings.msg.start_chat,offline_body:ylc.strings.msg.offline_body,busy_body:ylc.strings.msg.busy_body,close_msg:ylc.strings.msg.close_msg,close_msg_user:ylc.strings.msg.close_msg_user,reply_ph:ylc.strings.msg.reply_ph,send_btn:ylc.strings.msg.send_btn,no_op:ylc.strings.msg.no_op,no_msg:ylc.strings.msg.no_msg,sending:ylc.strings.msg.sending,connecting:ylc.strings.msg.connecting,writing:ylc.strings.msg.writing,please_wait:ylc.strings.msg.please_wait,chat_online:ylc.strings.msg.chat_online,chat_offline:ylc.strings.msg.chat_offline,your_msg:ylc.strings.msg.your_msg,end_chat:ylc.strings.msg.end_chat,conn_err:ylc.strings.msg.conn_err,you:ylc.strings.msg.you,online_btn:ylc.strings.msg.online_btn,offline_btn:ylc.strings.msg.offline_btn,field_empty:ylc.strings.msg.field_empty,invalid_email:ylc.strings.msg.invalid_email,invalid_username:ylc.strings.msg.invalid_username,user_name:ylc.strings.msg.user_name,user_email:ylc.strings.msg.user_email,user_ip:ylc.strings.msg.user_ip,user_page:ylc.strings.msg.user_page,connect:ylc.strings.msg.connect,disconnect:ylc.strings.msg.disconnect,you_offline:ylc.strings.msg.you_offline,save_chat:ylc.strings.msg.save_chat,ntf_close_console:ylc.strings.msg.ntf_close_console,new_msg:ylc.strings.msg.new_msg,new_user_online:ylc.strings.msg.new_user_online,saving:ylc.strings.msg.saving,waiting_users:ylc.strings.msg.waiting_users,good:ylc.strings.msg.good,bad:ylc.strings.msg.bad,chat_evaluation:ylc.strings.msg.chat_evaluation,talking_label:ylc.strings.msg.talking_label,timer:ylc.strings.msg.timer,chat_copy:ylc.strings.msg.chat_copy,already_logged:ylc.strings.msg.already_logged,current_shop:ylc.strings.msg.current_shop,macro_title:ylc.strings.msg.macro_title,macro_opts:ylc.strings.msg.macro_opts,macro_err:ylc.strings.msg.macro_err}},ylc.is_premium&&e.extend(this.premium,s),this.objs={last_cnv_id:null,last_user_id:null,last_msg_id:null,right_sidebar_html:"",list_interval:null,working:!1,checked_user_ids:[],new_msgs_count:{}};var i=this;e("#YLC_connect").click(function(t){t.preventDefault(),e("#YLC_notify").show().html(i.strings.msg.connecting+"..."),e(this).data("logged")?e(this).data("status","online")&&i.be_offline():i.login(!0)}),/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)&&(this.data.is_mobile=!0),this.post("ylc_ajax_callback","get_token",{},function(e){e.error||(i.data.auth_token=e.token,i.check_ntf(),i.auth())})},auth:function(e){return this.opts.app_id?(null==this.data.ref&&(this.data.ref=new Firebase("https://"+this.opts.app_id+".firebaseIO.com"),this.data.ref_conn=new Firebase("https://"+this.opts.app_id+".firebaseIO.com/.info/connected"),this.data.ref_cnv=new Firebase("https://"+this.opts.app_id+".firebaseIO.com/chat_sessions"),this.data.ref_msgs=new Firebase("https://"+this.opts.app_id+".firebaseIO.com/chat_messages"),this.data.ref_users=new Firebase("https://"+this.opts.app_id+".firebaseIO.com/chat_users")),this.login(!1,e),void this.after_load()):void console.error("App ID not provided")},after_load:function(){var i=this;e(s).on("keydown","#YLC_cnv_reply",function(){e(this).trigger("autosize.resize"),e(t).trigger("resize")}),e(s).on("focus","#YLC_cnv_reply",function(){e(this).autosize({append:""})}),e(s).on("click","#YLC_users li.free, #YLC_users li.busy",function(){var s=e(this);null!=i.objs.list_interval&&clearInterval(i.objs.list_interval),i.get_user_data(e(this).data("id"),function(a){i.data.active_user_id&&e("#YLC_chat_user_"+i.data.active_user_id).removeClass("chat-active"),s.addClass("chat-active").removeClass("new-msg").data("count",0).find(".chat-count").empty(),e("#YLC_popup_cnv").removeClass("chat-welcome").html(i.get_template("console-conversation",{reply_ph:i.strings.msg.reply_ph,load_msg:i.strings.msg.please_wait+"...",avatar:i.set_avatar(i.data.user.user_type,{gravatar:i.data.user.gravatar,avatar_type:i.data.user.avatar_type,avatar_image:i.data.user.avatar_image})})),e("#YLC_cnv_reply").focus(),s.data("id")!==i.data.user.user_id&&(i.objs.right_sidebar_html=i.get_template("console-user-tools",{save_chat_btn:ylc.is_premium?i.trigger_premium("show_save_button",s.data("cnv-id")):"",obj_user_data:s.data("cnv-id"),button_text:i.strings.msg.end_chat})),i.objs.right_sidebar_html=i.objs.right_sidebar_html+i.get_template("console-user-info",{name_title:i.strings.msg.user_name,name:a.user_name,ip_title:i.strings.msg.user_ip,ip_address:a.user_ip,info_title:i.strings.msg.user_email,email:a.user_email,page_title:i.strings.msg.user_page,href_current_page:a.current_page?a.current_page:"#",current_page:a.current_page?a.current_page:"N/A"}),i.objs.cnv=e("#YLC_cnv"),i.data.user.conversation_id=s.data("cnv-id"),i.data.active_user_id=s.data("id"),i.reload_cnv(s.data("cnv-id")),i.manage_reply_box(i.objs.last_cnv_id),i.objs.last_cnv_id=s.data("cnv-id"),e("#YLC_sidebar_right").html(i.objs.right_sidebar_html).show(),"free"==s.data("chat")?i.data.ref_users.child(s.data("id")).child("chat_with").set(i.data.user.user_id):s.data("chat")==i.data.user.user_id?e("#YLC_end_chat").show():e("#YLC_end_chat").hide(),ylc.is_premium&&(i.trigger_premium("show_chat_timer",s.data("cnv-id")),i.trigger_premium("show_macros")),e(t).trigger("resize")})}),e(s).on("click","#YLC_save, #YLC_end_chat",function(t){var s=e(this),a=e("#YLC_save_ntf"),n="YLC_end_chat"===e(this).attr("id"),r=new Date,o=r.getTime();return i.objs.working?void a.html(i.strings.msg.please_wait+"..."):(i.objs.working=!0,e(this).addClass("button-disabled"),a.html(i.strings.msg.saving+"..."),n&&null!=i.objs.list_interval&&clearInterval(i.objs.list_interval),void(ylc.is_premium?i.trigger_premium("end_chat_console",e(this).data("cnv-id"),n,o,s,a):i.clear_user_data(e(this).data("cnv-id"),function(){i.objs.working=!1,s.removeClass("button-disabled"),setTimeout(function(){a.fadeOut(500)},100),setTimeout(function(){i.show_welcome_popup()},1e3)})))}),e("#YLC_popup_cnv").mouseover(function(){e("#YLC_chat_user_"+i.data.active_user_id).removeClass("new-msg").data("count",0).find(".chat-count").empty()}),setInterval(function(){e(".chat-last-online").each(function(t){e(this).html(i.timeago(e(this).data("time")))})},6e4);var a=0;setInterval(function(){var t=0;i.data.ref_users.once("value",function(s){var i=s.val();null!==i&&e.each(i,function(e,s){s&&"wait"===s.status&&(t+=1)})}),a=t,t>0?e("#YLC_queue").html(i.strings.msg.waiting_users.replace(/%d/i,t)).show():e("#YLC_queue").hide()},15e3),t.onbeforeunload=function(e){var s=e||t.event;return s&&(s.returnValue=i.strings.msg.ntf_close_console),i.strings.msg.ntf_close_console}},login:function(t,s){var i=this;this.manage_connections(),this.data._new_user=t,this.data.auth=this.data.ref.authWithCustomToken(this.data.auth_token,function(t){t?(console.error(t.code,t.message),e("#YLC_connect").removeClass("button-disabled"),e("#YLC_notify").hide().html(t.message).fadeIn(200),i.display_ntf(i.strings.msg.conn_err,"error")):(e("#YLC_notify").html(i.strings.msg.you_offline),e("#YLC_connect").html(i.strings.msg.connect).data("logged",0).removeClass("button-disabled"),i.data.logged=!0,i.data.ref_users.once("value",function(t){var a=t.val(),n=0;if(null!==a){var r=Object.keys(a).length;e.each(a,function(e,t){n++,t&&"operator"==t.user_type&&"online"===t.status&&(i.data.online_ops[t.user_id]=t),n===r&&(i.data.mode="offline",i.check_user(i.opts.user_info.user_id))})}else i.data.mode="offline",i.check_user(i.opts.user_info.user_id);s&&s()}))})},logged_in:function(t){var s=this;ylc.is_premium&&s.trigger_premium("play_sound","connected"),s.listen_msgs(),e("#YLC_notify").hide().empty(),e("#YLC_connect").html('<i class="fa fa-check-circle" style="color:#acc327;"></i> '+s.strings.msg.online_btn).data("logged",1).data("status","online").removeClass("button-disabled"),s.purge_firebase()},logout:function(s){var i=this;this.data.user.user_id&&(i.data.ref_user.off(),i.data.ref_users.off(),i.data.ref_msgs.off(),ylc.is_premium&&i.trigger_premium("play_sound","offline"),e("#YLC_notify").html(i.strings.msg.you_offline),e("#YLC_connect").html(i.strings.msg.connect).data("logged",0).data("status","offline").removeClass("button-disabled"),i.show_welcome_popup()),ylc.is_premium?i.trigger_premium("end_chat_options",s):(s&&i.clear_user_data(i.data.user.conversation_id),setTimeout(function(){i.be_offline()},2e3)),e(t).trigger("resize"),i.offline()},be_offline:function(){this.data.mode="offline",this.data.ref_user&&(this.data.ref_user.child("status").set("offline"),this.data.ref_user.child("last_online").set(Firebase.ServerValue.TIMESTAMP)),this.offline()},offline:function(){var t=this;ylc.is_premium&&t.trigger_premium("play_sound","disconnected"),e("#YLC_notify").html(t.strings.msg.you_offline),e("#YLC_connect").html('<i class="fa fa-check-circle" style="color:#e54045;"></i> '+t.strings.msg.offline_btn).data("logged",0).data("status","offline").removeClass("button-disabled")},check_user:function(e){var t=this;this.data.ref_user=this.data.ref_users.child(e),this.data.ref_user.once("value",function(s){var i=s.val();i||(i={}),t.get_user(e,i)}),this.data.ref_user.child("chat_with").on("value",function(e){var s=e.val();null!=s&&(t.data.user.chat_with=s)}),this.data.ref_users.on("child_removed",function(s){var i=s.val();i&&e===i.user_id&&t.logout()})},get_user:function(e,t,s){var i=this;if(t.user_id)this.data.user=t,this.data.ref_user.child("status").set("offline"),this.data.ref_user.child("user_ip").set(this.opts.user_info.user_ip),this.data.ref_user.child("current_page").set(this.opts.user_info.current_page),this.data.ref_user.child("user_name").set(this.opts.user_info.user_name),this.data.ref_user.child("user_email").set(this.opts.user_info.user_email),this.data.ref_user.child("gravatar").set(this.opts.user_info.gravatar),this.data.ref_user.child("avatar_type").set(this.opts.user_info.avatar_type),this.data.ref_user.child("avatar_image").set(this.opts.user_info.avatar_image),this.data.ref_user.child("vendor_id").set(ylc.active_vendor.vendor_id),this.data.ref_user.child("vendor_name").set(ylc.active_vendor.vendor_name),this.data.mode="offline",this.manage_connections(),this.logged_in(this.data.user),this.listen_users(),s&&s();else if(this.data._new_user===!0){var a=this.data.ref_cnv.push({user_id:e,created_at:Firebase.ServerValue.TIMESTAMP,accepted_at:"",evaluation:"",user_type:"operator",receive_copy:!1}),n={user_id:e,conversation_id:a.key(),last_online:"",is_mobile:this.data.is_mobile,chat_with:"free",status:"online",vendor_id:ylc.active_vendor.vendor_id,vendor_name:ylc.active_vendor.vendor_name};for(var r in this.opts.user_info)n[r]=this.opts.user_info[r];this.data.user=n,this.data.ref_user.set(n,function(e){e||(i.data.mode="online",i.logged_in(i.data.user),i.manage_connections(),i.listen_users()),s&&s()})}else this.listen_users()},listen_users:function(){var t=this;this.data.last_changed_id=null,e("#YLC_users > ul").remove(),e("#YLC_users").append("<ul></ul>"),this.data.user_list=e("#YLC_users > ul"),this.data.ref_users.once("value",function(s){var i=s.val(),a=0;if(null!==i){var n=Object.keys(i).length;t.data.online_ops={},e.each(i,function(s,i){a+=1,i&&t.valid_operator(i.vendor_id)&&("operator"===i.user_type&&("online"===i.status?t.data.online_ops[i.user_id]=i:delete t.data.online_ops[i.user_id]),t.add_user_item(i)),a===n&&t.data.ref_users.on("value",function(s){e("#YLC_users > ul").empty();var i=s.val();e.each(i,function(e,s){t.valid_operator(s.vendor_id)&&t.update_user(s)})})})}})},update_user:function(t,s){(!t||t.user_id)&&(t&&(t.conversation_id?(this.add_user_item(t),"operator"===t.user_type&&("online"===t.status?this.data.online_ops[t.user_id]=t:delete this.data.online_ops[t.user_id]),s||-1==e.inArray(t.user_id,this.objs.checked_user_ids)&&t.user_id!=this.data.user.user_id&&(ylc.is_premium&&this.trigger_premium("play_sound","online"),"operator"!=t.user_type&&this.notify(this.strings.msg.new_user_online,t.user_name+" ("+t.user_type+")",null,"user_online"),this.objs.checked_user_ids.push(t.user_id)),this.data.active_user_id===t.user_id&&e("#YLC_active_page").attr("href",t.current_page).find("span").html(t.current_page)):this.clean_user_data(t.user_id)),this.data.last_changed_id=s)},clean_user_data:function(t){var s=this,i=this.data.ref_users.child(t);i.once("value",function(a){var n=a.val();i.remove(),n.conversation_id&&s.ref_cnv.child(n.conversation_id),s.data.ref_msgs.once("value",function(i){var a=i.val();a&&e.each(a,function(e,i){i.user_id===t&&s.data.ref_msgs.child(e).remove()})})})},add_user_item:function(s){if(s.user_id&&this.data.user_list){var i="",a=!1,n="#YLC_chat_user_"+s.user_id;"free"!=s.chat_with&&(null==this.data.online_ops[s.chat_with]?(this.data.ref_users.child(s.user_id).child("chat_with").set("free"),a=!1):(a=s.chat_with!=this.data.user.user_id,i=this.data.online_ops[s.chat_with].user_name));var r=a?" busy":" free",o="offline"===s.status||"wait"===s.status?' - <span class="other-info" data-time="'+s.last_online+'">'+this.timeago(s.last_online)+"</span>":"",_=a?'<br /><span class="other-info">'+this.strings.msg.talking_label.replace(/%s/i,i)+"</span>":"",c="";"operator"==s.user_type&&(r=" op"),ylc.yith_wpv_active&&"0"==ylc.active_vendor.vendor_id&&(c=0==s.vendor_id?"":this.strings.msg.current_shop.replace(/%s/i,s.vendor_name)+" "),e(n).remove(),this.data.user_list.append(this.get_template("console-user-item",{id:s.user_id,"class":"user-"+s.status+" user-"+s.user_type+r,color:s.color||"transparent",username:s.user_name||s.user_email||"N/A",is_mobile:s.is_mobile?'<i class="fa fa-mobile"></i>':"",avatar:this.set_avatar(s.user_type,{gravatar:s.gravatar,avatar_type:s.avatar_type,avatar_image:s.avatar_image}),cnv_id:s.conversation_id,chat_with:s.chat_with,meta:c+s.user_type+o+_}));var l=e(n);if(s.user_id==this.data.active_user_id)l.addClass("chat-active").removeClass("new-msg").data("count",0).find(".chat-count").empty(),null!=this.objs.new_msgs_count[s.user_id]&&(this.objs.new_msgs_count[s.user_id]=0);else{var u=null!=this.objs.new_msgs_count[s.user_id]?this.objs.new_msgs_count[s.user_id]:0;u>0&&l.data("count",u).find(".chat-count").html("("+u+")")}e(t).trigger("resize")}},notify:function(e,s,i,a){if(Notification&&"Notification"in t)if("granted"===Notification.permission){var n=new Notification(e,{body:s,icon:ylc.plugin_url+"/images/ylc-ico.png",tag:a});i?n.onclick=function(){i()}:n.close(),setTimeout(function(){n.close()},4e3)}else"denied"!==Notification.permission&&Notification.requestPermission(function(t){if("permission"in Notification||(Notification.permission=t),"granted"===t){var a=new Notification(e,{body:s});i?a.onclick=function(){i()}:a.close(),setTimeout(function(){a.close()},4e3)}})},set_avatar:function(e,t){return e="operator"==e?"admin":"user",ylc.is_premium?this.trigger_premium("set_avatar_premium",e,t):this.data.assets_url+"/images/default-avatar-"+e+".png"},time:function(e,t){return this.strings.time[e]&&this.strings.time[e].replace(/%d/i,Math.abs(Math.round(t)))},timeago:function(e){if(!e)return"";var t=new Date,s=.001*(t.getTime()-e)>>0,i=s/60,a=i/60,n=a/24,r=n/365;return(45>s&&this.time("seconds",s)||90>s&&this.time("minute",1)||45>i&&this.time("minutes",i)||90>i&&this.time("hour",1)||24>a&&this.time("hours",a)||42>a&&this.time("day",1)||30>n&&this.time("days",n)||45>n&&this.time("month",1)||365>n&&this.time("months",n/30)||1.5>r&&this.time("year",1)||this.time("years",r))+" "+this.strings.time.suffix},listen_msgs:function(){var t=this;this.data.ref_msgs.off(),this.data.ref_msgs.once("value",function(s){var i=s.val(),a=i?Object.keys(i).length:0,n=1;i?e.each(i,function(e,s){s.first_load=!0,t.new_msg(s),a==n&&t.listen_new_msgs(e),n+=1}):t.listen_new_msgs()})},new_msg:function(t,s){var i=this;if(i.valid_operator(t.vendor_id)){var a=e("#YLC_chat_user_"+t.user_id),n=a.find(".chat-count"),r=parseInt(a.data("count"));0!=t.read||t.user_id==i.data.user.user_id||s||(r+=1,i.objs.new_msgs_count[t.user_id]=r,a.addClass("new-msg").data("count",r),n.html("("+r+")"),ylc.is_premium&&i.trigger_premium("play_sound","new-msg"),i.notify(i.strings.msg.new_msg,t.user_name+": "+t.msg,null,"new_msg")),i.data.user.conversation_id==t.conversation_id&&(e("#YLC_load_msg").remove(),i.add_msg(t,i.objs.last_user_id,i.objs.last_msg_id),i.objs.last_user_id=t.user_id,i.objs.last_user_id==t.user_id&&i.objs.last_msg_id||(i.objs.last_msg_id=t.msg_id)),s&&i.data.ref_msgs.child(s).child("read").set(!0)}},listen_new_msgs:function(e){var t=this,s=e?t.data.ref_msgs.startAt(null,e):t.data.ref_msgs,i=!0;e||(i=!1),s.on("child_added",function(e){var s=e.val();s.id=e.key(),t.new_msg(s),i=!1})},add_msg:function(e,t,s){var i=new Date,a=new Date(e.msg_time),n=a.getHours()+":"+(a.getMinutes()<10?"0":"")+a.getMinutes(),r=this.sanitize_msg(e.msg),o=a.toDateString()==i.toDateString()?n:a.getUTCDate()+" "+this.strings.months_short[a.getUTCMonth()]+", "+n;this.objs.cnv&&this.objs.cnv.append(this.get_template("console-chat-line",{msg_id:e.id,time:o,date:a.getUTCDate()+" "+this.strings.months[a.getUTCMonth()]+" "+a.getUTCFullYear()+" "+n,color:"transparent",avatar:this.set_avatar(e.user_type,{gravatar:e.gravatar,avatar_type:e.avatar_type,avatar_image:e.avatar_image}),name:e.user_name,msg:r,"class":e.user_id==this.data.user.user_id?" chat-you":""})).scrollTop(this.objs.cnv.prop("scrollHeight"))},sanitize_msg:function(e){var t,s,i,a,n,r={"&":"&amp;","<":"&lt;",">":"&gt;"};return t=e.replace(/[&<>]/g,function(e){return r[e]||e}),n=/\n/gim,t=t.replace(n,"<br />"),s=/(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim,t=t.replace(s,'<a href="$1" target="_blank">$1</a>'),i=/(^|[^\/])(www\.[\S]+(\b|$))/gim,t=t.replace(i,'$1<a href="http://$2" target="_blank">$2</a>'),a=/(([a-zA-Z0-9\-\_\.])+@[a-zA-Z\_]+?(\.[a-zA-Z]{2,6})+)/gim,t=t.replace(a,'<a href="mailto:$1">$1</a>')},manage_reply_box:function(t){var s=this,i=!1,a=e("#YLC_cnv_reply"),n=function(){var e=0;return function(t,s){clearTimeout(e),e=setTimeout(t,s)}}();this.data.ref_cnv.child(this.data.user.conversation_id+"/typing").remove(),a.keydown(function(t){if(13!==t.keyCode||t.shiftKey){if(!i){switch(t.keyCode){case 17:case 18:case 16:case 9:case 8:case 224:case 17:case 91:case 93:return}s.data.ref_cnv.child(s.data.user.conversation_id+"/typing/"+s.data.user.user_id).set(s.data.user.user_name),i=!0}n(function(){s.data.ref_cnv.child(s.data.user.conversation_id+"/typing/"+s.data.user.user_id).remove(),i=!1},1300)}else{t.preventDefault();var a=e(this).val();a&&(e(this).val("").trigger("autosize.resize"),s.push_msg(a),s.data.ref_cnv.child(s.data.user.conversation_id+"/typing/"+s.data.user.user_id).remove())}}),t&&(this.data.ref_cnv.child(t+"/typing").off(),this.data.ref_cnv.child(t).off("child_added")),this.data.ref_cnv.child(this.data.user.conversation_id+"/typing").on("value",function(t){var i=0,a=t.val(),n=a?Object.keys(a).length:0;return a?void e.each(a,function(e,t){return null!=e&&e!=s.data.user.user_id?void s.display_ntf(s.strings.msg.writing.replace(/%s/i,t),"typing"):(n===i&&s.clean_ntf(),void(i+=1))}):void s.clean_ntf()}),this.data.ref_cnv.child(this.data.user.conversation_id).on("child_added",function(t){"closed"==t.val()&&(e("#YLC_cnv_reply").attr("disabled","disabled"),e(".chat-cnv-input").addClass("chat-disabled"))})},reload_cnv:function(t){var s=this;this.data.ref_msgs.once("value",function(i){var a=(new Date,i.val()),n=a?Object.keys(a).length:0,r=0,o=1;a?e.each(a,function(e,i){i.conversation_id==t&&(s.new_msg(i,e),r+=1),n==o&&s.cnv_msgs_loaded(r),o+=1}):s.cnv_msgs_loaded(0)})},cnv_msgs_loaded:function(t){t?e("#YLC_load_msg").empty():e("#YLC_load_msg").html(this.strings.msg.no_msg+".")},push_msg:function(e){this.data.ref_msgs.push({user_id:this.data.user.user_id,user_type:this.data.user.user_type,conversation_id:this.data.user.conversation_id,user_name:this.data.user.user_name||this.data.user.user_email,gravatar:this.data.user.gravatar,avatar_type:this.data.user.avatar_type,avatar_image:this.data.user.avatar_image,msg:e,msg_time:Firebase.ServerValue.TIMESTAMP,vendor_id:ylc.active_vendor.vendor_id,read:!0})},get_template:function(e,t){var s;switch(e){case"console-chat-line":s=ylc.templates.console_chat_line;break;case"console-user-item":s=ylc.templates.console_user_item;break;case"console-conversation":s=ylc.templates.console_conversation;break;case"console-user-info":s=ylc.templates.console_user_info;break;case"console-user-tools":s=ylc.templates.console_user_tools;break;case"console-user-tools-premium":s=ylc.templates.premium.console_user_tools_premium;break;case"console-user-timer-premium":s=ylc.templates.premium.console_user_timer_premium;break;case"console-macro-premium":s=ylc.templates.premium.console_macro_premium;break;default:s=""}return this.string_replace(s,t)},string_replace:function(e,t){for(var s in t)if(t.hasOwnProperty(s)){var i=new RegExp("ylc."+s,"gm");e=e.replace(i,t[s])}return e},get_user_data:function(e,t){this.data.ref_users.child(e).once("value",function(e){var s=e.val();t(s)})},manage_connections:function(){var t=this;this.data.ref_user&&this.data.ref_conn.on("value",function(s){if(s.val()===!0){e("#YLC_firebase_offline").hide();var i=t.data.ref_user.child("connections").push(!0);i.onDisconnect().remove(),t.data.ref_user.child("status").set("online"),t.data.ref_user.child("status").onDisconnect().set("offline"),t.data.ref_user.child("last_online").onDisconnect().set(Firebase.ServerValue.TIMESTAMP),t.data.ref_cnv.child(t.data.user.conversation_id+"/typing/"+t.data.user.user_id).onDisconnect().remove()}else e("#YLC_firebase_offline").show()})},post:function(t,s,i,a){e.post(ylc.ajax_url+"?action="+t+"&mode="+s,i,a,"json").fail(function(e){return console.log(s,": ",e),!1})},trigger_premium:function(e,t,s,i,a,n,r){return this.premium[e].call(this,t,s,i,a,n,r)},check_ntf:function(){"Notification"in t&&"denied"!==Notification.permission&&Notification.requestPermission(function(e){"permission"in Notification||(Notification.permission=e)})},display_ntf:function(t,s){var i;switch(s){case"success":i='<i class="fa fa-check"></i> ';break;case"error":i='<i class="fa fa-exclamation-triangle"></i> ';break;case"typing":i='<i class="fa fa-pencil-square-o"></i> ';break;default:i=""}e("#YLC_popup_ntf").removeClass().addClass("chat-ntf chat-"+s).html(i+t).fadeIn(300)},clean_ntf:function(){e("#YLC_popup_ntf").html("").hide()},clear_user_data:function(t,s){var i=this;this.data.ref_cnv.child(t).once("value",function(a){var n=a.val();if(n){var r=n.user_id;i.data.ref_msgs.once("value",function(a){var n=a.val(),o=n?Object.keys(n).length:0,_=0;n?e.each(n,function(e,a){_+=1,a.conversation_id===t&&i.data.ref_msgs.child(e).remove(),o===_&&s&&s()}):s&&s(),i.data.ref_users.child(r).remove(),i.data.ref_cnv.child(t).remove()})}})},total_online_ops:function(){return this.data.online_ops?Object.keys(this.data.online_ops).length:0},purge_firebase:function(t){var s=this;this.data.ref_users.once("value",function(i){var a=i.val(),n=0,r=[],o=[],_=[],c=t?0:3600;if(null!==a){var l=Object.keys(a).length,u=new Date;e.each(a,function(t,i){if(n++,i&&"offline"===i.status){var a=.001*(u.getTime()-i.last_online)>>0;a>=c&&("operator"!=i.user_type?null!=i.conversation_id?o.push(i.conversation_id):r.push(t):(r.push(t),_.push(i.conversation_id)))}n===l&&(e.each(r,function(e,t){s.data.ref_users.child(t).remove()}),e.each(_,function(e,t){s.data.ref_cnv.child(t).remove()}),e.each(o,function(e,t){ylc.is_premium?s.trigger_premium("save_user_data",t,!0,u.getTime()):s.clear_user_data(t)}))})}})},show_welcome_popup:function(){e("#YLC_popup_cnv").addClass("chat-welcome").html(""),e("#YLC_sidebar_right").html("").hide()},valid_operator:function(e){return ylc.yith_wpv_active?ylc.yith_wpv_active&&ylc.active_vendor.vendor_id===e?!0:ylc.yith_wpv_active&&"0"==ylc.active_vendor.vendor_id&&!ylc.vendor_only_chat?!0:!1:!0}},e.fn[n]=function(t,s){var i,o;if(this.data(r)instanceof a||this.data(r,new a(this)),o=this.data(r),o.el=this,"undefined"==typeof t||"object"==typeof t)"function"==typeof o.init&&o.init(t,s);else{if("string"==typeof t&&"function"==typeof o[t])return i=Array.prototype.slice.call(arguments,1),o[t].apply(o,i);e.error("Method "+t+" does not exist on jQuery."+n)}}}(jQuery,window,document);